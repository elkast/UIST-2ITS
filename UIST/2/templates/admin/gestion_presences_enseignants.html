{% extends "base.html" %}

{% block titre %}Gestion des Pr√©sences Enseignants - UIST-2ITS{% endblock %}

{% block contenu %}
<div class="mb-6">
    <a href="{{ url_for('admin.tableau_bord') }}" class="text-uist-bleu hover:underline flex items-center mb-4">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Retour au tableau de bord
    </a>
    <h1 class="text-3xl font-bold text-gray-800 mb-2">‚úÖ Gestion des Pr√©sences Enseignants</h1>
    <p class="text-gray-600">Marquer et consulter les pr√©sences des enseignants</p>
</div>

<!-- Filtres -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
            <input type="date" id="dateFiltre" value="{{ date_selectionnee or today }}" onchange="chargerPresences()"
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uist-bleu">
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Enseignant</label>
            <select id="enseignantFiltre" onchange="chargerPresences()"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uist-bleu">
                <option value="">Tous les enseignants</option>
                {% for ens in enseignants %}
                <option value="{{ ens.id }}" {% if enseignant_selectionne and enseignant_selectionne.id == ens.id %}selected{% endif %}>
                    {{ ens.nom }} {{ ens.prenom }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Statut</label>
            <select id="statutFiltre" onchange="chargerPresences()"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-uist-bleu">
                <option value="">Tous les statuts</option>
                <option value="present">Pr√©sent</option>
                <option value="absent">Absent</option>
                <option value="retard">En retard</option>
                <option value="non_marque">Non marqu√©</option>
            </select>
        </div>
        <div class="flex items-end">
            <button onclick="chargerPresences()" class="w-full bg-uist-bleu hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                üîç Filtrer
            </button>
        </div>
    </div>
</div>

<!-- Statistiques -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-blue-50 rounded-lg p-4">
        <div class="text-sm text-gray-600">Total Enseignants</div>
        <div class="text-2xl font-bold text-blue-600">{{ stats.total_enseignants }}</div>
    </div>
    <div class="bg-green-50 rounded-lg p-4">
        <div class="text-sm text-gray-600">Pr√©sents</div>
        <div class="text-2xl font-bold text-green-600">{{ stats.presents }}</div>
    </div>
    <div class="bg-red-50 rounded-lg p-4">
        <div class="text-sm text-gray-600">Absents</div>
        <div class="text-2xl font-bold text-red-600">{{ stats.absents }}</div>
    </div>
    <div class="bg-yellow-50 rounded-lg p-4">
        <div class="text-sm text-gray-600">Taux Pr√©sence</div>
        <div class="text-2xl font-bold text-yellow-600">{{ stats.taux_presence }}%</div>
    </div>
</div>

<!-- Tableau des pr√©sences -->
<div class="bg-white rounded-lg shadow-md overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Enseignant</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cours</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Horaire</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Salle</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="tableauPresences">
                <!-- Les donn√©es seront charg√©es dynamiquement -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Marquer Pr√©sence -->
<div id="modalPresence" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-lg bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-900">Marquer Pr√©sence</h3>
            <button onclick="fermerModalPresence()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
        </div>

        <div id="modalContent">
            <!-- Le contenu sera charg√© dynamiquement -->
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
let currentDate = '{{ date_selectionnee or today }}';
let currentEnseignant = '{{ enseignant_selectionne.id if enseignant_selectionne else "" }}';
let currentStatut = '';

function chargerPresences() {
    const date = document.getElementById('dateFiltre').value;
    const enseignant = document.getElementById('enseignantFiltre').value;
    const statut = document.getElementById('statutFiltre').value;

    currentDate = date;
    currentEnseignant = enseignant;
    currentStatut = statut;

    fetch(`/api/presences/enseignants?date=${date}&enseignant_id=${enseignant}&statut=${statut}`)
        .then(response => response.json())
        .then(data => {
            afficherPresences(data.presences);
            mettreAJourStats(data.stats);
        })
        .catch(error => console.error('Erreur:', error));
}

function afficherPresences(presences) {
    const tbody = document.getElementById('tableauPresences');
    tbody.innerHTML = '';

    if (presences.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    Aucune pr√©sence trouv√©e pour ces crit√®res
                </td>
            </tr>
        `;
        return;
    }

    presences.forEach(presence => {
        const statutBadge = getStatutBadge(presence.statut);
        const actionsBtn = presence.statut === 'non_marque' ?
            `<button onclick="marquerPresence(${presence.creneau_id}, ${presence.enseignant_id})" class="text-blue-600 hover:text-blue-800">Marquer</button>` :
            `<button onclick="modifierPresence(${presence.creneau_id}, ${presence.enseignant_id})" class="text-green-600 hover:text-green-800">Modifier</button>`;

        tbody.innerHTML += `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${presence.enseignant_nom} ${presence.enseignant_prenom}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${presence.nom_cours}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${presence.heure_debut} - ${presence.heure_fin}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${presence.nom_salle}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${statutBadge}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${actionsBtn}
                </td>
            </tr>
        `;
    });
}

function getStatutBadge(statut) {
    const badges = {
        'present': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Pr√©sent</span>',
        'absent': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Absent</span>',
        'retard': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Retard</span>',
        'non_marque': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Non marqu√©</span>'
    };
    return badges[statut] || badges['non_marque'];
}

function mettreAJourStats(stats) {
    document.querySelector('.bg-blue-50 .text-2xl').textContent = stats.total_enseignants;
    document.querySelector('.bg-green-50 .text-2xl').textContent = stats.presents;
    document.querySelector('.bg-red-50 .text-2xl').textContent = stats.absents;
    document.querySelector('.bg-yellow-50 .text-2xl').textContent = stats.taux_presence + '%';
}

function marquerPresence(creneauId, enseignantId) {
    ouvrirModalPresence(creneauId, enseignantId, false);
}

function modifierPresence(creneauId, enseignantId) {
    ouvrirModalPresence(creneauId, enseignantId, true);
}

function ouvrirModalPresence(creneauId, enseignantId, isModification = false) {
    const modal = document.getElementById('modalPresence');
    const content = document.getElementById('modalContent');

    // Charger le formulaire
    fetch(`/api/presences/form?creneau_id=${creneauId}&enseignant_id=${enseignantId}&date=${currentDate}&modification=${isModification}`)
        .then(response => response.text())
        .then(html => {
            content.innerHTML = html;
            modal.classList.remove('hidden');
        });
}

function fermerModalPresence() {
    document.getElementById('modalPresence').classList.add('hidden');
}

// Charger les pr√©sences au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    chargerPresences();
});
</script>

{% endblock %}
